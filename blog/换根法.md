# 换根法

更换树根会导致树的某个性质发生改变，而题目需要我们分别求出以每一点为根时，对应的性质的值。树的性质举例如下：

- [P3478](https://www.luogu.com.cn/problem/P3478)，所有节点深度之和；
- [P2986](https://www.luogu.com.cn/problem/P2986)，所有节点的点权和深度之积的和；
- [P3047](https://www.luogu.com.cn/problem/P3047)，所有深度小于等于$k$的节点点权之和；
- [CF219D](https://www.luogu.com.cn/problem/CF219D)，所有由儿子指向父亲的边数。

所谓换根法，是指将问题分为两步：

1. 先任取一点为根建树，并求出此时的答案；
2. 不断将当前树根的一个儿子变成树根、当前树根变成这个儿子的儿子（所谓换根），求出这种变化对答案的影响，直到遍历全树。

拿到题目，首先不考虑换根问题，先构造递归状态量$f(u)$（可能视情况要引入其他维度），对每个节点$u$求值后递归得到当前根节点的答案。

而“换根”这一操作可以通过引入`cut`和`link`两个互逆的过程来操作：

- `cut(u, v)`：当前`v`是`u`的儿子，我们把以`v`为根的子树从以`u`为根的切断，并统计切断操作对`u`的答案产生的影响；
- `link(u, v)`：将`v`变成`u`的儿子，即把以`v`为根的子树连接到`u`下面，并统计连接操作对`u`的答案产生的影响。

而将原先的树根`u`和它的一个儿子`v`进行换根，就相当于先进行`cut(u, v)`，再进行`link(v, u)`操作。

以上就是换根法的主要精神。

一旦完成了解决问题的第一步，第二步的换根法应当是容易的。原因在于在第一步，我们在递归计算$f(u)$的每一步都在进行`link`操作，由此可以容易地得到其逆过程`cut`，进而得到换根操作。

但也有时我们可以通过数学关系直接求出换根操作的递推式，这时`cut`和`link`反而可能会比较麻烦。